#!/usr/bin/env ruby

require 'csv'
require 'shellwords'

begin
  CSV.open(ARGV[0], 'rb').each { }
rescue CSV::MalformedCSVError => e
  puts e.class.to_s + ': ' + e.message
  if e.message =~ /Missing or stray quote in line (\d+)/
    lineno = $1.to_i
    cmd = "csv-readline #{Shellwords.escape(ARGV[0])} #{lineno}"
    puts "running #{cmd}"
    system(cmd)
  end
  exit 1
end

puts 'CSV file is ok'
